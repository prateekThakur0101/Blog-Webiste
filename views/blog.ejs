<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/head')%>
  <title><%= blog.title %> - Blogify</title>
</head>
<body>
  <%- include('./partials/nav')%>

  <div class="container my-5">
    <!-- Blog Header -->
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="blog-header text-center mb-5">
          <h1 class="blog-title fade-in-up"><%= blog.title %></h1>
          <div class="author-info fade-in-up" style="animation-delay: 0.2s;">
            <img src="<%= blog.createdBy.profileImageURL %>" alt="<%= blog.createdBy.fullName %>" class="author-avatar" width="60" height="60">
            <div>
              <div class="author-name"><%= blog.createdBy.fullName %></div>
              <small class="text-muted">
                <i class="bi bi-calendar3 me-1"></i>
                <%= new Date(blog.createdAt).toLocaleDateString('en-US', { 
                  year: 'numeric', 
                  month: 'long', 
                  day: 'numeric' 
                }) %>
              </small>
            </div>
          </div>
        </div>
        
        <!-- Blog Image -->
        <div class="text-center mb-5 fade-in-up" style="animation-delay: 0.4s;">
          <img src="<%= blog.coverImageUrl %>" alt="<%= blog.title %>" class="blog-image img-fluid" style="max-height: 500px; width: 100%; object-fit: cover;" />
        </div>
        
        <!-- Blog Content -->
        <div class="blog-content fade-in-up" style="animation-delay: 0.6s;">
          <p style="white-space: pre-line;"><%= blog.body %></p>
        </div>

        <!-- Edit/Delete Options for Blog Owner -->
        <% if (locals.user && user._id.toString() === blog.createdBy._id.toString()) { %>
          <div class="d-flex gap-2 mt-4 fade-in-up" style="animation-delay: 0.8s;">
            <a href="/blog/edit/<%= blog._id %>" class="btn btn-outline-secondary">
              <i class="bi bi-pencil me-1"></i>Edit Blog
            </a>
            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteBlogModal">
              <i class="bi bi-trash me-1"></i>Delete Blog
            </button>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Delete Blog Modal -->
  <% if (locals.user && user._id.toString() === blog.createdBy._id.toString()) { %>
    <div class="modal fade" id="deleteBlogModal" tabindex="-1" aria-labelledby="deleteBlogModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title" id="deleteBlogModalLabel">
              <i class="bi bi-exclamation-triangle text-danger me-2"></i>Confirm Delete
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete "<strong><%= blog.title %></strong>"?</p>
            <p class="text-muted mb-0">
              <i class="bi bi-info-circle me-1"></i>This action cannot be undone. All comments will also be deleted.
            </p>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="bi bi-x me-1"></i>Cancel
            </button>
            <form action="/blog/delete/<%= blog._id %>" method="post" style="display: inline;">
              <button type="submit" class="btn btn-danger">
                <i class="bi bi-trash me-1"></i>Delete Blog
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Comments Section -->
  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="comments-section">
          <h3 class="mb-4">
            <i class="bi bi-chat-dots me-2"></i>
            Comments (<%= comments.length %>)
          </h3>
          
          <!-- Add Comment Form -->
          <% if (locals.user) { %>
            <form action="/blog/comment/<%= blog._id %>" method="post" class="mb-4">
              <div class="d-flex gap-3 align-items-start">
                <img src="<%= user.profileImageURL %>" alt="<%= user.fullName %>" class="author-avatar flex-shrink-0" width="40" height="40">
                <div class="flex-grow-1">
                  <div class="form-floating mb-3">
                    <textarea name="content" class="form-control" placeholder="Share your thoughts..." id="commentTextarea" style="height: 100px; resize: none;" required></textarea>
                    <label for="commentTextarea">Share your thoughts...</label>
                  </div>
                  <button class="btn btn-modern" type="submit">
                    <i class="bi bi-send me-2"></i>Post Comment
                  </button>
                </div>
              </div>
            </form>
          <% } else { %>
            <div class="alert alert-info" role="alert">
              <i class="bi bi-info-circle me-2"></i>
              <a href="/user/signin" class="alert-link">Sign in</a> to join the conversation and share your thoughts!
            </div>
          <% } %>
          
          <!-- Comments List -->
          <% if (comments.length === 0) { %>
            <div class="text-center py-5">
              <i class="bi bi-chat display-4 text-muted mb-3"></i>
              <h5 class="text-muted">No comments yet</h5>
              <p class="text-muted">Be the first to share your thoughts!</p>
            </div>
          <% } else { %>
            <div class="mt-4">
              <% comments.forEach((comment, index) => { %>
                <div class="comment-item fade-in" style="animation-delay: <%= index * 0.1 %>s;">
                  <div class="comment-author mb-2">
                    <img src="<%= comment.createdBy.profileImageURL %>" alt="<%= comment.createdBy.fullName %>" class="author-avatar" width="35" height="35">
                    <div>
                      <strong class="text-dark"><%= comment.createdBy.fullName %></strong>
                      <small class="text-muted ms-2">
                        <i class="bi bi-clock me-1"></i>
                        <%= new Date(comment.createdAt).toLocaleDateString() %>
                      </small>
                    </div>
                  </div>
                  <div class="comment-content">
                    <%= comment.content %>
                  </div>
                  <div class="comment-actions mt-2">
                    <% if (locals.user) { %>
                      <% const hasLiked = comment.likes.some(like => like.toString() === user._id.toString()); %>
                      <button class="btn btn-sm <%= hasLiked ? 'btn-primary' : 'btn-outline-primary' %> like-btn" 
                              data-comment-id="<%= comment._id %>" 
                              onclick="toggleLike(this)">
                        <i class="bi <%= hasLiked ? 'bi-heart-fill' : 'bi-heart' %> me-1"></i>
                        <span class="like-count"><%= comment.likes.length %></span>
                      </button>
                    <% } else { %>
                      <button class="btn btn-sm btn-outline-secondary" disabled>
                        <i class="bi bi-heart me-1"></i>
                        <span><%= comment.likes.length %></span>
                      </button>
                    <% } %>
                  </div>
                </div>
              <% }) %>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Related Posts Section -->
  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-8 text-center">
        <h4 class="mb-4">Continue Reading</h4>
        <a href="/" class="btn btn-outline-primary">
          <i class="bi bi-arrow-left me-2"></i>Back to All Stories
        </a>
      </div>
    </div>
  </div>

  <%- include('./partials/footer')%>
  <%- include('./partials/scripts')%>
  
  <script>
    async function toggleLike(button) {
      const commentId = button.getAttribute('data-comment-id');
      
      // Disable button during request
      button.disabled = true;
      
      try {
        const response = await fetch(`/blog/comment/${commentId}/like`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Update the like count
          const likeCountSpan = button.querySelector('.like-count');
          likeCountSpan.textContent = data.likes;
          
          // Toggle button style
          const icon = button.querySelector('i');
          if (data.liked) {
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-primary');
            icon.classList.remove('bi-heart');
            icon.classList.add('bi-heart-fill');
          } else {
            button.classList.remove('btn-primary');
            button.classList.add('btn-outline-primary');
            icon.classList.remove('bi-heart-fill');
            icon.classList.add('bi-heart');
          }
        } else {
          alert('Error: ' + (data.error || 'Failed to like comment'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to like comment. Please try again.');
      } finally {
        // Re-enable button
        button.disabled = false;
      }
    }
  </script>
</body>
</html>
